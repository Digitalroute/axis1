<html>
<head>
<title>Mail transport</title>

</head>

<body>
<h1>MTOM with Axis2 </h1>
<h2>Introduction</h2>
<p>Despite the flexibility, interoperability and global acceptance of XML, there are times when serializing data into XML does not make sense. Web services users may need to transmit binary attachments of various sorts like images, drawings, xml docs, etc together with SOAP message. Such data are often in a particular binary format.<br>
  Traditionally, two techniques for dealing with opaque data in XML have been used; &quot;by value&quot; or &quot;by reference&quot;. The former is achieved by embedding opaque data(ofcource after some form of encoding) as element or attribute content. XML supports opaque data as content through the use of either base64 or hexadecimal text encoding. It is well-known that base64 encoded data expands by a factor of 1.33x original size, and that hexadecimal encoded data expands by a factor of 2x, assuming an underlying UTF-8 text encoding. Also of concern is the overhead in processing costs (both real and perceived) for these formats, especially when decoding back into raw binary. The latter &quot;by reference&quot; is achieved by attaching the pure binary data 


 as external unparsed general entities

outside of the XML and then embedding a reference URI  as an element or attribute value. This prevents the uneccesary bloating of data and wasted processing power.


The primary obstacle to using unparsed entities is their heavy reliance on DTDs, which impedes modularity as well as use of XML namespaces. </p>
<p>There were several specifications introduced in the SOAP world to deal with this binary attachment problem. <a href="http://www.w3.org/TR/SOAP-attachments">SOAP with Attachments</a> is one such example.It uses &quot;by reference&quot; method. Since SOAP prohibits document type declarations (DTD) in messages, this leads to the  problem of not  representing data as part of the message infoset, creating two data models. This scenerio is like sending attachments with an e-mail message. Even though those attachements are related to the message content they are not inside the message.  This causes the technologies 


 for processing and description of data based on XML component of the data, to malfunction. One example is  WS-Security. </p>
<p><a href="http://www.w3.org/TR/2004/PR-soap12-mtom-20041116/">MTOM 


(SOAP Message Transmission Optimization Mechanism)</a> is a elegent solution  for the above problems created by merging the above two techniques. MTOM is actually a &quot;by reference&quot; method. Wire format of a MTOM optimised message is same as the Soap with Attachments message , which also makes it backward compatible with SwA endpoints. Most notable feature of MTOM is the use of XOP:Include element which is declared in <a href="http://www.w3.org/TR/2004/PR-xop10-20041116/">XML Binary Optimized Packaging (XOP)</a> specification to refer to the binary attachments of the message.With the use of this exclusive element the attached binary content logically become inline(by value) with the SOAP document even though actually it is attached seperately. This merges the two realms by making it possible to work only with one data model. With this the it becomes trivial to idetify the data by looking at XML making reliance on DTDs obsolute. With this the technologies which works based XML component of the data can work with one data model. </p>
<h2>Using MTOM </h2>
First you need to replace geronimo-spec-javamail-1.3.1-rc3.jar and geronimo-spec-activation-1.0.2-rc3.jar jars by following  dependencies in the classpath, they can be  downloaded from the Sun web site. 
<ol>
  <LI><a href="http://java.sun.com/products/javamail/">Java Mail API (mail.jar)</a></LI>
  <LI><a href="http://java.sun.com/products/javabeans/glasgow/jaf.html">Java Activation Framework (activation.jar)</a></LI>
</ol>

<h3>Programming model </h3>
<p>AXIOM has the ability to hold binary data. It has been given this ability by allowing OMText to hold binary content in the form of javax.activation.DataHandler.  OMText has been chosen for this purpose with two reasons. One is that MTOM can be enabled only for content which has <source>xs:base64Binary</source>

representations and the other one is to preserve the infoset in both sender and receiver. The option of serializing as optimised or not can be given at the constructing time or later.</p>
<source>
<pre>        OMElement imageElement = fac.createOMElement("image", omNs);

		  //creating the Data Handler for the image
        Image image;
        image = new JDK13IO()
                .loadImage(new FileInputStream(inputImageFileName));
        ImageDataSource dataSource = new ImageDataSource("test.jpg",image);
        DataHandler dataHandler = new DataHandler(dataSource);

		  //create a OMText node with the above DataHandler and set optimised to true
        OMText textData = fac.createText(dataHandler, true);
        imageElement.addChild(textData);

		  //to set optimized to false uncomment the following
		  //textData.doOptimize(false);</pre>
</source>
<p>Also a user can create an optimizable binary content node even with a base64 encoded string which contains binary content given with the mime type of the actual binary representation</p>
<source>
<pre>		   String base64String = "xxxxxxxx";
		   OMText binaryNode =  fac.createText(base64String,"image/jpg",true);</pre>
</source>
<p>Axis2 uses javax.activation.DataHandler to handle the binary data. All optimised binary content nodes will be serialised as Base64 Strings if MTOM is not enabled. One can also create binary content nodes which will not be optimised at any case. They will be serialised and send as Base64 Strings. </p>
<source>
<pre>			//create a OMText node with the above DataHandler and set optimised to true 
			OMText textData = fac.createText(dataHandler, false); 
			image.addChild(textData);</pre>
</source>
<h3>Sending MTOM optimised messages from  client side </h3>
<p>First of all you need to have the above mentioned jars in the classpath. Then set the <source>&quot;enableMTOM&quot;</source> property in the call to true, when sending messages.</p>
<source>
   <pre>	  		Call call = new Call();
    		call.setTo(targetEPR);
    		call.set(Constants.Configuration.ENABLE_MTOM, Constants.VALUE_TRUE);</pre>
</source>
<p> When this property is set to true any message which contains optimisable content will be serialised as MTOM optimised messages. If this the message contains optimizable binary content nodes and the above property is *not* set then the optimizable binary content will be serialized and sent as Base64 strings.Axis2 will automatically identify and de-serilize any MTOM messge it receives. </p>
<h3>Enabling MTOM in the Server side </h3>
<p>When the above jars are present Axis 2 server automatically identifies MTOM optimsed messages based on the content-type and de-serializes. When serializing and sending the messages user can specify whether to enable MTOM optimization or not. One can enable  MTOM optimisation globally on the server side by setting the &quot;enableMTOM&quot; parameter to true in the Axis2.xml. When it is set,  outgoing messages *which contains optimizable content* will be serialized and send as a MTOM optimized messages. If it is not set all the binary content nodes will be serialized as Base64 encoded strings. </p>
<p>1. Copy the new jars to the Axis 2 lib folder  and delete the above mentioned Gerenimo jars from there.  If the Axis2 server is running in Tomcat Axis 2 lib is &lt;CATALINA_HOME&gt;/webapps/axis2/WEB-INF/lib.</p>
<p>2. Add the following parameter entries to Axis2.xml file which can be found in &lt;AXIS2_HOME&gt;/WEB_INF folder. </p>
 <source><pre>
         &lt;parameter name=&quot;enableMTOM&quot; locked=&quot;xsd:false&quot;&gt;true&lt;/parameter&gt;
  </pre></source>
<p>3. Restart the Server.</p>
<h2>Using SOAP with Attachments (SwA) </h2>
<p>MTOM specification is designed to be backward compatible with the SOAP with Attachements specification. Even though the representation is different, both technologies have the same wire format. We can safely assume that any SOAP with Attachments endpoint can accept a MTOM optimized messages and  treat them as SOAP with Attachment messages - Any MTOM optimised message is a valid SwA message. Because of that Axis2 does not define a seperate programming model or serialization for SwA. Users can use the MTOM programming model and serialization to send messages to SwA endpoints.</p>
<p>In the receiving side Axis2 automatically identifies and de-serilizes SOAP with Attachments messages by looking at the content type of the message. Reference to the received attachments will be put in to the message context. </p>
</body>
</html>